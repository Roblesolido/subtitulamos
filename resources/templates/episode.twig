{% extends "base.twig" %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="css/episode.css?v=0.0.3"/>
{% endblock %}

{% block content %}

<div id="subtitle_content">
    <div id="subtitle_content_title_container">
        <a href='{{ prev_url }}' {% if not prev_url %}disabled{% endif %}>
            <div id="previous_episode" class="clips_pages_button hint--top hint--bounce hint--rounded" data-hint="Episodio Anterior">
                <i class="fa fa-angle-left" aria-hidden="true"></i>
            </div>
        </a>
        <div id="episode_title">
            <a href='/shows/{{ episode.show.id }}'>{{ episode.show.name }}</a> <span id="season_number"><a href='/shows/{{ episode.show.id }}/{{ episode.season }}'>{{ episode.season }}</a></span>x<span id="episode_number">{% if episode.number < 10 %}0{% endif %}{{ episode.number }}</span>- {{ episode.name }}
        </div>	
        <a href='{{ next_url }}' {% if not next_url %}disabled{% endif %}>
            <div id="next_episode" class="clips_pages_button hint--top hint--bounce hint--rounded" data-hint="Siguiente Episodio">
                <i class="fa fa-angle-right" aria-hidden="true"></i>	
            </div>
        </a>
    </div>
    <div id="subtitle_details">

        {% for lang, subs in langs %}
            <div class="subtitle_language">{{ lang }}</div>
            {% for sub in subs %}
                {% if sub.progress < 20 %}
                    {% set progress_class = '019' %}
                {% elseif sub.progress < 50 %}
                    {% set progress_class = '2049' %}
                {% elseif sub.progress < 70 %}
                    {% set progress_class = '5069' %}
                {% elseif sub.progress < 80 %}
                    {% set progress_class = '7079' %}
                {% elseif sub.progress < 90 %}
                    {% set progress_class = '8089' %}
                {% elseif sub.progress < 100 %}
                    {% set progress_class = '9099' %}
                {% elseif sub.progress >= 100 %}
                    {% set progress_class = '100' %}
                {% endif %}

                <div id="progress_buttons_row" class="compact" {# only compact if admin #}>
                    <div class="version_name">{{ sub.version.name }}</div>		
                    <div id="translation_progress_bar">
                        {% if sub.directUpload %}
                            <div class="progress progress_original_subtitle">
                                <div id="subtitle_uploader">subtítulo original subido por <a href="/user/{{ sub.version.user.id }}" class="uploader_name">{{ sub.version.user.username }}</a>{# TODO: , hace 10 días #}</div>
                            </div>
                        {% else %}
                            <div class="progress progress_{{ progress_class }}" style="width: {{ max(sub.progress//1, 7) }}%"><div class="progress_percentage">{{ sub.progress // 1}}%</div></div>
                        {% endif %}
                    </div>
                    <div class="subtitle_buttons">
                        <a href="/subtitles/{{ sub.id }}/download">
                            <div class="download_subtitle" {# TODO: class should be button wrapper or something! #}><i class="fa fa-download" aria-hidden="true"></i></div>
                        </a>
                        <a href="/subtitles/{{ sub.id }}/translate"><div class="edit_subtitle hint--bottom hint--rounded" {# TODO: class should be button wrapper or something! #}
                                data-hint="Colaborar en la traducción">
                                <i class="fa fa-file-text" aria-hidden="true"></i>
                            </div> 
                        </a>
                        {% if auth.has_role('ROLE_MOD') %}
                            <a data-action="delete" data-id="{{ sub.id }}">
                                <div class="delete_subtitle" {# TODO: class should be button wrapper or something! #}><i class="fa fa-times" aria-hidden="true"></i></div>
                            </a>
                            <div class="antitroll_subtitle"><i class="fa fa-gavel" aria-hidden="true"></i></div>
                        {% endif %}
                    </div>

                    {% if sub.directUpload %}
                        <div class="version_comments">
                            <p><i class="fa fa-comment" aria-hidden="true"></i> {{ sub.version.comments }}</p>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endfor %}

        <div id="subtitle-actions">
            <a href='/episodes/{{ episode.id }}/resync'>
                <div class="resyncreq_subtitle hint--bottom hint--rounded"
                    data-hint="Subir una resincronización">
                    <i class="fa fa-refresh" aria-hidden="true"></i>
                </div>
            </a>
            <div id="new-translation">
                <div class="translate_subtitle hint--bottom hint--rounded"
                    data-hint="Abrir una nueva traducción"> {# TODO: class should be button wrapper or something! #}
                    <i class="fa fa-plus-circle" aria-hidden="true"></i>
                </div>

                <div id="new-translation-opts" class="hidden">
                    <form action="/subtitles/translate" method="POST">
                        <input type="hidden" name="episode" value="{{ episode.id }}" />
                        <select name="lang" id="translate-to-lang">
                            <option value="1">English</option>
                            <option value="5">Español (España)</option>
                            <option value="6">Español (Latinoamérica)</option>
                            <option value="12">Català</option>
                            <option value="15">Galego</option>
                        </select>

                        <button type="submit" id="open-translation">Abrir traducción</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="subtitle-comments">
        <h4>Comentarios</h4>

        <template v-for="comment in comments">
            <comment
                :key="comment.id"

                :id="comment.id"
                :user="comment.user"
                :text="comment.text"
                :published-at="comment.published_at"
            >
            </comment>
        </template>

        <div class='newcomment-box'>
            {% if auth.logged %}
                <textarea id="new-comment" v-model="newComment" placeholder="Escribe aquí tu comentario..."></textarea>
                <button :class="{'hidden': newComment == ''}" class="comment-publish" @click="publishComment">Enviar</button>
            {% else %}
                <textarea id="new-comment" disabled placeholder="Debes estar identificado para poder dejar comentarios"></textarea>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="js/timeago.min.js"></script>
    <script type="text/javascript">
        let epId = {{ episode.id }};
        let $newTranslationButton = $(".translate_subtitle");
        let canDeleteComments = {{ auth.has_role('ROLE_MOD') ? 'true' : 'false' }};

        $newTranslationButton.on("click", function() {
            $("#new-translation-opts").toggleClass("hidden");
        });

        $("a[disabled]").on("click", function(e) {
            e.preventDefault();
            return false;
        });

        $("a[data-action='delete']").on("click", function(e) {
            let subId = $(this).data("id");
            alertify.confirm("¿Estás seguro de querer borrar este subtítulo? Esta acción no es reversible.", function() {
                window.location = "/subtitles/"+subId+"/delete";
            })
            
        });

        {% verbatim %}
        Vue.component('comment', {
            template: `
                <article class='comment'>
                    <header>
                        <ul>
                            <li class='comment-user'>
                                <a :href="'/user/' + user.id">{{ user.name }}</a>
                            </li>
                            <li class='comment-time'>
                                {{ date }}
                            </li>
                            <li class='comment-actions' v-if="canDelete">
                                <i class="fa fa-times" aria-hidden="true" @click="remove"></i>
                            </li>
                        </ul>
                    </header>
                    <section class='comment-body'>
                        {{ text }}
                    </section>
                    <section class='comment-actions'>
                    </section>
                </article>
                `,
            
            props: ['id', 'user', 'text', 'published-at'],
            data: function() {
                return {
                    date: '',
                    canDelete: canDeleteComments
                }
            },
            created: function() {
                this.update = setInterval(this.updateDate, 10000);
                this.updateDate();
            },
            methods: {
                updateDate: function() {
                    this.date = timeago().format(this.publishedAt, 'es')
                },

                remove: function() {
                    $.ajax({
                        url: '/episodes/'+epId+'/comments/'+this.id,
                        method: 'DELETE'
                    }).done(function() {
                        loadComments();
                    })
                }
            }
        });
        {% endverbatim %}
        
        let comments = new Vue({
            el: '#subtitle-comments',
            data: {
                newComment: '',
                comments: [
                ]
            },
            methods: {
                publishComment: function() {
                    let comment = this.newComment;
                    this.newComment = '';

                    $.ajax({
                        url: '/episodes/'+epId+'/comments/submit',
                        method: 'POST',
                        data: {
                            text: comment
                        }
                    }).done(function() {
                        // Cheap solution: reload the entire comment box
                        loadComments();
                    }).fail(function() {
                        alertify.error("Ha ocurrido un error al enviar tu comentario");
                    });
                }
            }
        });

        function loadComments()
        {
            $.ajax({
                url: '/episodes/'+epId+'/comments',
                method: 'GET'
            }).done(function(reply) {
                comments.comments = reply;
            }).fail(function() {
                alertify.error("Ha ocurrido un error tratando de cargar los comentarios");
            })
        }

        // Start by loading the comments, and set a timer to do so frequently
        loadComments();
        setInterval(loadComments, 60000);
    </script>
{% endblock %}